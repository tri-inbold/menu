<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InBold Food Menu</title>    

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --bg-gradient: linear-gradient(135deg, #1e293b 0%, #334155 25%, #475569 50%, #334155 75%, #1e293b 100%);
            --text-primary: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --panel-bg: rgba(30, 41, 59, 0.95);
            --border-color: rgba(148, 163, 184, 0.2);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundMove 20s ease-in-out infinite;
        }
        
        @keyframes backgroundMove { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        
        .app-container { flex: 1; display: flex; flex-direction: column; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; height: 100%; overflow: hidden; }
        
        /* Toggle Header */
        .toggle-header { display: flex; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 20px; padding: 6px; margin-bottom: 40px; align-self: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(148, 163, 184, 0.1); position: relative; }
        .toggle-button { padding: 14px 28px; background: transparent; border: none; border-radius: 16px; font-size: 16px; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); min-width: 120px; position: relative; z-index: 2; }
        .toggle-button.active { background: var(--accent-gradient); color: #ffffff; box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.2); transform: translateY(-1px); }
        .toggle-button:hover:not(.active) { background: rgba(30, 41, 59, 0.6); color: var(--text-primary); transform: translateY(-1px); }
        
        /* Loading Overlay */
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .loading-text { font-size: 18px; color: #94a3b8; font-weight: 600; text-align: center; }
        
        /* Today Mode */
        .today-mode { flex: 1; display: none; flex-direction: column; align-items: center; justify-content: center; gap: 30px; padding: 20px; }
        .today-mode.active { display: flex; }
        .today-content { text-align: center; max-width: 600px; width: 100%; }
        .today-greeting { font-size: 22px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;}
        .today-greeting .user-name { font-weight: 700; color: #fff; }
        .today-dish-name { font-size: 40px; font-weight: 800; color: #ffffff; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; min-height: 50px; }
        
        .eaten-button { background: var(--success-gradient); color: #ffffff; font-size: 24px; font-weight: 700; padding: 20px 40px; border: none; border-radius: 24px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3), 0 4px 6px -2px rgba(16, 185, 129, 0.2); width: 100%; max-width: 400px; }
        .eaten-button:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.4), 0 10px 10px -5px rgba(16, 185, 129, 0.2); }
        .eaten-button:disabled { background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%); cursor: not-allowed; transform: none; box-shadow: none; }
        
        .user-selector-wrapper { position: relative; max-width: 400px; width: 100%; }
        .user-selector { width: 100%; padding: 12px 16px; font-size: 16px; border: none; border-radius: 12px; background: transparent; color: var(--text-primary); outline: none; font-weight: 500; appearance: none; cursor: pointer; text-align: center; border-bottom: 2px solid var(--border-color); }
        .user-selector:focus { border-color: rgba(59, 130, 246, 0.5); }
        
        /* Menu Mode */
        .menu-mode { flex: 1; display: none; flex-direction: column; }
        .menu-mode.active { display: flex; }
        .menu-controls { margin-bottom: 24px; display: flex; justify-content: center; align-items: center; gap: 12px; }
        .menu-search { flex-grow: 1; max-width: 450px; }
        .menu-search input { width: 100%; padding: 18px 24px; font-size: 16px; border: 2px solid var(--border-color); border-radius: 20px; background: var(--panel-bg); backdrop-filter: blur(20px); color: #ffffff; outline: none; font-weight: 600; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(148, 163, 184, 0.1); }
        .menu-search input::placeholder { color: var(--text-muted); }
        .menu-search input:focus { border-color: rgba(59, 130, 246, 0.5); background: rgba(30, 41, 59, 0.95); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.2), 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .shift-filter-btn { font-size: 24px; background: var(--panel-bg); border: 2px solid var(--border-color); border-radius: 50%; width: 56px; height: 56px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; }
        .shift-filter-btn:hover { border-color: rgba(59, 130, 246, 0.5); transform: scale(1.05); }

        .menu-container { background: var(--panel-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(148, 163, 184, 0.1); overflow: hidden; height: calc(100vh - 220px); display: flex; flex-direction: column; }
        .menu-content { flex: 1; overflow-y: auto; }
        .menu-table { width: 100%; border-collapse: collapse; }
        .menu-table th { background: rgba(59, 130, 246, 0.1); backdrop-filter: blur(10px); padding: 20px 24px; text-align: left; font-weight: 700; color: #ffffff; border-bottom: 2px solid rgba(148, 163, 184, 0.1); position: sticky; top: 0; z-index: 5; font-size: 16px; }
        .menu-table th:first-child { width: 60px; text-align: center; }
        .menu-table td { padding: 18px 24px; border-bottom: 1px solid rgba(148, 163, 184, 0.05); color: var(--text-secondary); font-weight: 500; font-size: 15px; }
        .menu-table td:first-child { text-align: center; }
        .menu-table tr { transition: background-color 0.2s ease, opacity 0.3s ease; }
        .menu-table tr:hover { background: rgba(59, 130, 246, 0.05); }
        .menu-table tr.eaten-row { opacity: 0.5; }
        .menu-table tr.eaten-row:hover { opacity: 0.7; }
        
        .checkbox-container input[type="checkbox"] { width: 20px; height: 20px; accent-color: #10b981; cursor: pointer; }
        
        /* About Mode */
        .about-mode { flex: 1; display: none; align-items: center; justify-content: center; padding: 20px; overflow-y: auto; }
        .about-mode.active { display: flex; }
        .about-container { background: var(--panel-bg); backdrop-filter: blur(20px); border: 1px solid var(--border-color); border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(148, 163, 184, 0.1); padding: 40px; max-width: 550px; width: 100%; }
        .about-section { margin-bottom: 32px; }
        .about-section:last-child { margin-bottom: 0; }
        .about-title { font-size: 24px; font-weight: 800; color: #ffffff; margin-bottom: 20px; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .about-list { list-style: none; padding: 0; }
        .about-list li { padding: 2px 0 2px 28px; color: var(--text-secondary); font-size: 16px; position: relative; line-height: 1.6; }
        .about-list li:before { content: "‚Ä¢"; color: #3b82f6; font-weight: bold; position: absolute; left: 0; font-size: 20px; }
        .contact-button { display: inline-block; background: var(--accent-gradient); color: #ffffff; font-size: 16px; font-weight: 600; padding: 14px 28px; border: none; border-radius: 16px; text-decoration: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -2px rgba(59, 130, 246, 0.2); cursor: pointer; margin-right: 12px; margin-bottom: 12px; }
        .contact-button:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(59, 130, 246, 0.4), 0 10px 10px -5px rgba(59, 130, 246, 0.2); }
        .contact-button.danger { background: var(--danger-gradient); box-shadow: 0 10px 15px -3px rgba(239, 68, 68, 0.3), 0 4px 6px -2px rgba(239, 68, 68, 0.2); }
        .contact-button.danger:hover { box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.4), 0 10px 10px -5px rgba(239, 68, 68, 0.2); }
        
        .hidden { display: none !important; }
        
        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container { padding: 16px; }
            .today-greeting { font-size: 18px; }
            .today-dish-name { font-size: 32px; min-height: 40px; }
            .eaten-button { font-size: 20px; padding: 18px 32px; }
            .toggle-button { font-size: 14px; padding: 12px 24px; min-width: 100px; }
            .menu-table th, .menu-table td { padding: 16px 20px; font-size: 14px; }
            .about-container { padding: 32px 24px; }
            .menu-search input { font-size: 14px; padding: 16px 20px; }
            .shift-filter-btn { width: 50px; height: 50px; font-size: 22px; }
        }
        
        @media (max-width: 480px) {
            .today-greeting { font-size: 16px; }
            .today-dish-name { font-size: 24px; min-height: 30px; }
            .eaten-button { font-size: 18px; padding: 16px 28px; }
            .toggle-button { font-size: 13px; padding: 10px 16px; min-width: 0; }
            .toggle-header { padding: 4px; }
            .about-container { padding: 24px 20px; margin: 12px; }
            .menu-search input { padding: 14px 18px; }
            .toggle-header { margin-bottom: 32px; }
        }
        
        /* Custom Scrollbar */
        .menu-content::-webkit-scrollbar { width: 8px; }
        .menu-content::-webkit-scrollbar-track { background: rgba(148, 163, 184, 0.1); border-radius: 4px; }
        .menu-content::-webkit-scrollbar-thumb { background: var(--accent-gradient); border-radius: 4px; }
        .menu-content::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #2563eb, #7c3aed); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-text" id="loading-text">ƒêang kh·ªüi t·∫°o...</div>
        </div>
        
        <!-- Toggle Header -->
        <div class="toggle-header" id="toggle-header">
            <button class="toggle-button" id="menu-tab" data-mode="menu">Menu</button>
            <button class="toggle-button active" id="today-tab" data-mode="today">Today</button>
            <button class="toggle-button" id="about-tab" data-mode="about">About</button>
        </div>
        
        <!-- Today Mode -->
        <div class="today-mode active" id="today-mode">
            <div class="today-content">
                <p class="today-greeting" id="today-greeting">Ch√†o <span class="user-name">b·∫°n</span>,</p>
                <h2 class="today-dish-name" id="dish-name">ƒêang t·∫£i...</h2>
            </div>
            
            <button class="eaten-button" id="eaten-button" onclick="markAsEaten()">
                ƒê√£ ƒÉn
            </button>
            
            <div class="user-selector-wrapper">
                <select id="user-select" class="user-selector">
                    <option value="">-- Ch·ªçn t√™n c·ªßa b·∫°n --</option>
                </select>
            </div>
        </div>
        
        <!-- Menu Mode -->
        <div class="menu-mode" id="menu-mode">
            <div class="menu-controls">
                <div class="menu-search">
                    <input type="text" id="menu-search-input" placeholder="T√¨m ki·∫øm t√™n nh√¢n vi√™n..." autocomplete="off">
                </div>
                <button class="shift-filter-btn" id="shift-filter-btn" title="L·ªçc theo ca">üòÇ</button>
            </div>
            <div class="menu-container">
                <div class="menu-content">
                    <table class="menu-table" id="menu-table">
                        <!-- Table content will be populated by JavaScript -->
                    </table>
                </div>
            </div>
        </div>
        
        <!-- About Mode -->
        <div class="about-mode" id="about-mode">
            <div class="about-container">
                <div class="about-section">
                    <h3 class="about-title">Features:</h3>
                    <ul class="about-list">
                        <li>Xem m√≥n ƒÉn h√¥m nay theo th·ª© trong tu·∫ßn.</li>
                        <li>ƒê√°nh d·∫•u v√† b·ªè ƒë√°nh d·∫•u ƒë√£ ƒÉn cho t·ª´ng ng∆∞·ªùi.</li>
                        <li>T√¨m ki·∫øm v√† l·ªçc nh√¢n vi√™n theo ca l√†m vi·ªác.</li>
                        <li>Hi·ªÉn th·ªã menu theo ng√†y trong tu·∫ßn.</li>
                        <li>T√≠ch h·ª£p Google Sheets ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu real-time.</li>
                        <li>L∆∞u l·∫°i t√™n ng∆∞·ªùi d√πng ƒë√£ ch·ªçn.</li>
                    </ul>
                </div>
                <div class="about-section">
                    <button class="contact-button danger" onclick="clearCacheAndReload()">X√≥a Cache</button>
                    <a href="mailto:tri.vu.trong@inbold.com" class="contact-button">tri.vu.trong@inbold.com</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        class FoodMenuApp {
            constructor() {
                // Config -- ƒê√É ƒêI·ªÄN S·∫¥N KEY C·ª¶A B·∫†N
                this.SHEET_ID = '11mnJvKd0T-HPMjO5Rf1B6zAn3cMGbbi9dcfWevCUB9g';
                this.API_KEY = 'AIzaSyDypKkzhsZ_aai6YozkoP4cywXSW1z_vvc';
                this.SHEET_NAME = 'Sheet1'; // Quan tr·ªçng: T√™n sheet trong file Google Sheets ph·∫£i l√† "Sheet1"
                this.APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxruI1r43fNEC31VVBYR-xGedlvKtVP4MATybBPyAbccwYDt3Bmyhz5Ruxi2oSTzzGz/exec';
                
                // ƒê·ªïi key ƒë·ªÉ x√≥a cache c≈©
                this.CACHE_KEY = 'food_menu_data_v7';
                
                // UI Elements
                this.loadingOverlay = document.getElementById('loading-overlay');
                this.loadingText = document.getElementById('loading-text');
                this.menuTab = document.getElementById('menu-tab');
                this.todayTab = document.getElementById('today-tab');
                this.aboutTab = document.getElementById('about-tab');
                this.menuMode = document.getElementById('menu-mode');
                this.todayMode = document.getElementById('today-mode');
                this.aboutMode = document.getElementById('about-mode');
                
                // Today Mode
                this.dishName = document.getElementById('dish-name');
                this.eatenButton = document.getElementById('eaten-button');
                this.userSelect = document.getElementById('user-select');
                this.todayGreeting = document.getElementById('today-greeting');

                // Menu Mode
                this.menuTable = document.getElementById('menu-table');
                this.menuSearchInput = document.getElementById('menu-search-input');
                this.shiftFilterBtn = document.getElementById('shift-filter-btn');

                // State
                this.allUsersData = [];
                this.currentMode = 'today';
                this.selectedUser = null; // Object
                this.updateInterval = null;
                this.shiftFilters = ['all', 'day', 'evening'];
                this.currentShiftFilterIndex = 0; // 'all'
                this.shiftIcons = ['üòÇ', '‚òÄÔ∏è', 'üåô'];
                
                this.initEventListeners();
                this.init();
            }

            // --- DATA & API METHODS ---

            async fetchData() {
                const readUrl = `https://sheets.googleapis.com/v4/spreadsheets/${this.SHEET_ID}/values/${this.SHEET_NAME}?key=${this.API_KEY}`;
                try {
                    const response = await fetch(readUrl);
                    if (!response.ok) throw new Error(`Google Sheets API error: ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.values || data.values.length < 2) throw new Error('No data found in sheet');

                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    
                    this.allUsersData = rows.map(row => {
                        const user = {};
                        headers.forEach((header, index) => {
                            user[header] = row[index] || '';
                        });
                        return user;
                    }).filter(user => user['T√™n'] && user['T√™n'].trim() !== ''); // L·ªçc ng∆∞·ªùi d√πng c√≥ t√™n
                    
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(this.allUsersData));
                    console.log(`Loaded ${this.allUsersData.length} users from Google Sheets`);
                } catch (error) {
                    console.error('Failed to load from Google Sheets:', error);
                    const cachedData = localStorage.getItem(this.CACHE_KEY);
                    if (cachedData) {
                        this.allUsersData = JSON.parse(cachedData);
                        console.warn('Loaded data from cache due to API error.');
                    } else {
                        throw new Error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}`);
                    }
                }
            }

            async updateEatenStatus(userName, isEaten) {
                if (!this.APPS_SCRIPT_URL.startsWith('https')) {
                    throw new Error('URL Apps Script kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.');
                }
                try {
                    const response = await fetch(this.APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'cors',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ userName, isEaten })
                    });
                    
                    const result = await response.json();
                    if (result.status !== 'success') {
                        throw new Error(result.message);
                    }
                    return true;
                } catch (error) {
                    console.error('Failed to update eaten status via Apps Script:', error);
                    throw error;
                }
            }
            
            // --- INITIALIZATION ---

            initEventListeners() {
                this.menuTab.addEventListener('click', () => this.switchMode('menu'));
                this.todayTab.addEventListener('click', () => this.switchMode('today'));
                this.aboutTab.addEventListener('click', () => this.switchMode('about'));
                
                this.menuSearchInput.addEventListener('input', () => this.renderMenuTable());
                this.shiftFilterBtn.addEventListener('click', () => this.toggleShiftFilter());
                this.userSelect.addEventListener('change', (e) => this.handleUserSelection(e.target.value));
            }

            async init() {
                try {
                    this.updateLoadingText('ƒêang t·∫£i d·ªØ li·ªáu...');
                    await this.fetchData();
                    
                    this.populateUserSelect();
                    this.loadSavedUser();
                    
                    this.updateTodayView();
                    this.startPeriodicUpdates();
                    this.hideLoading();
                } catch (error) {
                    this.updateLoadingText(`L·ªói: ${error.message}. Vui l√≤ng th·ª≠ x√≥a cache.`);
                    console.error('Init error:', error);
                }
            }

            // --- UI & LOGIC ---

            switchMode(mode) {
                this.currentMode = mode;
                
                document.querySelectorAll('.toggle-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${mode}-tab`).classList.add('active');

                document.querySelectorAll('.today-mode, .menu-mode, .about-mode').forEach(m => m.classList.remove('active'));
                document.getElementById(`${mode}-mode`).classList.add('active');
                
                if (mode === 'menu') {
                    this.renderMenuTable();
                }
            }

            populateUserSelect() {
                this.userSelect.innerHTML = '<option value="">-- Ch·ªçn t√™n c·ªßa b·∫°n --</option>';
                this.allUsersData
                    .sort((a, b) => a['T√™n'].localeCompare(b['T√™n']))
                    .forEach(user => {
                        const option = document.createElement('option');
                        option.value = user['T√™n'].replace("‚Ä¢ ", "");
                        option.textContent = user['T√™n'].replace("‚Ä¢ ", "");
                        this.userSelect.appendChild(option);
                    });
            }
            
            loadSavedUser() {
                const savedUserName = localStorage.getItem('selected_user');
                if (savedUserName) {
                    this.handleUserSelection(savedUserName);
                    this.userSelect.value = savedUserName;
                }
            }
            
            handleUserSelection(userName) {
                if (userName) {
                    this.selectedUser = this.allUsersData.find(u => u['T√™n'].replace("‚Ä¢ ", "") === userName) || null;
                    localStorage.setItem('selected_user', userName);
                } else {
                    this.selectedUser = null;
                    localStorage.removeItem('selected_user');
                }
                this.updateTodayView();
            }

            updateTodayView() {
                const today = new Date().getDay();
                const dayMapping = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
                const currentDayKey = dayMapping[today] || 'Th·ª© 2';

                if (this.selectedUser) {
                    const userName = this.selectedUser['T√™n'].replace("‚Ä¢ ", "");
                    this.todayGreeting.innerHTML = `Ch√†o <span class="user-name">${userName}</span>, h√¥m nay b·∫°n ƒÉn:`;
                    this.dishName.textContent = this.selectedUser[currentDayKey] || 'Ch∆∞a c√≥ th√¥ng tin';
                    this.updateEatenButtonState();
                } else {
                    this.todayGreeting.innerHTML = 'Vui l√≤ng ch·ªçn t√™n c·ªßa b·∫°n';
                    this.dishName.textContent = 'ƒë·ªÉ xem m√≥n ƒÉn h√¥m nay';
                    this.eatenButton.disabled = true;
                    this.eatenButton.textContent = 'ƒê√£ ƒÉn';
                }
            }

            updateEatenButtonState() {
                if (!this.selectedUser) return;

                const hasEaten = this.hasEatenToday(this.selectedUser);
                this.eatenButton.disabled = hasEaten;
                this.eatenButton.textContent = hasEaten ? 'ƒê√£ ƒÉn r·ªìi' : 'ƒê√£ ƒÉn';
            }

            hasEatenToday(user) {
                return user['Eaten'] && user['Eaten'].trim() !== '' || user['T√™n'].startsWith("‚Ä¢ ");
            }

            async markAsEaten() {
                if (!this.selectedUser) {
                    alert('Vui l√≤ng ch·ªçn t√™n c·ªßa b·∫°n tr∆∞·ªõc.');
                    return;
                }
                
                const userName = this.selectedUser['T√™n'].replace("‚Ä¢ ", "");
                this.eatenButton.disabled = true;
                this.eatenButton.textContent = 'ƒêang c·∫≠p nh·∫≠t...';

                try {
                    await this.updateEatenStatus(userName, true);
                    
                    // Update local data immediately for instant UI feedback
                    this.selectedUser['Eaten'] = new Date().toISOString();
                    this.selectedUser['T√™n'] = "‚Ä¢ " + userName;
                    this.eatenButton.textContent = 'ƒê√£ ƒÉn r·ªìi';

                    // Refresh menu table if visible
                    if (this.currentMode === 'menu') this.renderMenuTable();

                } catch (error) {
                    alert(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                    this.updateEatenButtonState(); // Revert button state on failure
                }
            }

            // --- MENU MODE ---
            
            toggleShiftFilter() {
                this.currentShiftFilterIndex = (this.currentShiftFilterIndex + 1) % this.shiftFilters.length;
                this.shiftFilterBtn.textContent = this.shiftIcons[this.currentShiftFilterIndex];
                this.shiftFilterBtn.title = `L·ªçc: ${this.shiftFilters[this.currentShiftFilterIndex]}`;
                this.renderMenuTable();
            }

            getFilteredMenuData() {
                const searchQuery = this.menuSearchInput.value.toLowerCase().trim();
                const currentShift = this.shiftFilters[this.currentShiftFilterIndex];

                const shiftMap = {
                    'day': 'Ca s√°ng / Day shift',
                    'evening': 'Ca chi·ªÅu / Evening shift'
                };

                return this.allUsersData.filter(user => {
                    // Filter by shift
                    if (currentShift !== 'all' && user['Ca'] !== shiftMap[currentShift]) {
                        return false;
                    }
                    // Filter by search query
                    if (searchQuery) {
                        const name = user['T√™n'].replace("‚Ä¢ ", "").toLowerCase();
                        const unsignedName = this.removeDiacritics(name);
                        return name.includes(searchQuery) || unsignedName.includes(searchQuery);
                    }
                    return true;
                });
            }

            renderMenuTable() {
                const filteredData = this.getFilteredMenuData();
                
                if (filteredData.length === 0) {
                    this.menuTable.innerHTML = '<thead><tr><th colspan="3" style="text-align: center; padding: 40px; color: #64748b;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</th></tr></thead>';
                    return;
                }
                
                const today = new Date().getDay();
                const dayMapping = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
                const currentDayKey = dayMapping[today] || 'Th·ª© 2';

                const headerRow = `<th>‚úì</th><th>T√™n</th><th>${currentDayKey}</th>`;
                
                const bodyRows = filteredData.map(user => {
                    const hasEaten = this.hasEatenToday(user);
                    const userName = user['T√™n'].replace("‚Ä¢ ", "");
                    return `
                        <tr class="${hasEaten ? 'eaten-row' : ''}">
                            <td>
                                <div class="checkbox-container">
                                    <input type="checkbox" ${hasEaten ? 'checked' : ''} 
                                           onchange="handleCheckboxChange('${userName}', this.checked)">
                                </div>
                            </td>
                            <td>${userName}</td>
                            <td>${user[currentDayKey] || ''}</td>
                        </tr>
                    `;
                }).join('');
                
                this.menuTable.innerHTML = `<thead><tr>${headerRow}</tr></thead><tbody>${bodyRows}</tbody>`;
            }

            async handleCheckboxChange(userName, isChecked) {
                const user = this.allUsersData.find(u => u['T√™n'].replace("‚Ä¢ ", "") === userName);
                if (!user) return;
                
                const row = [...this.menuTable.querySelectorAll('tbody tr')].find(r => r.cells[1].textContent === userName);
                
                try {
                    await this.updateEatenStatus(userName, isChecked);
                    
                    // Update local data
                    user['Eaten'] = isChecked ? new Date().toISOString() : '';
                    user['T√™n'] = isChecked ? "‚Ä¢ " + userName : userName;
                    if (row) row.classList.toggle('eaten-row', isChecked);
                    
                    // Update today view if the current user is the one being changed
                    if (this.selectedUser && this.selectedUser['T√™n'].replace("‚Ä¢ ", "") === userName) {
                        this.updateEatenButtonState();
                    }

                } catch (error) {
                    alert(`Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i.`);
                    // Revert checkbox state on failure
                    const checkbox = row.querySelector('input[type="checkbox"]');
                    if (checkbox) checkbox.checked = !isChecked;
                }
            }

            // --- UTILITIES ---

            startPeriodicUpdates() {
                this.updateInterval = setInterval(async () => {
                    try {
                        await this.fetchData();
                        this.populateUserSelect(); // Repopulate to get name updates (‚Ä¢)
                        
                        const currentSelectedValue = this.userSelect.value;
                        if(currentSelectedValue) this.handleUserSelection(currentSelectedValue);

                        if (this.currentMode === 'menu') this.renderMenuTable();
                    } catch (error) {
                        console.warn('Periodic update failed:', error);
                    }
                }, 60000); // Update every 60 seconds
            }

            updateLoadingText(text) { this.loadingText.textContent = text; }
            hideLoading() { this.loadingOverlay.classList.add('hidden'); }
            removeDiacritics(str) { return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒë/g, 'd').replace(/ƒê/g, 'D'); }
            destroy() { if (this.updateInterval) clearInterval(this.updateInterval); }
        }
        
        // --- GLOBAL SCOPE ---
        let app;
        
        function markAsEaten() { app?.markAsEaten(); }
        function handleCheckboxChange(userName, isChecked) { app?.handleCheckboxChange(userName, isChecked); }
        
        function clearCacheAndReload() {
            if (confirm('X√≥a cache s·∫Ω t·∫£i l·∫°i d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ Google Sheets. B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                localStorage.removeItem('food_menu_data_v7'); // ƒê√£ c·∫≠p nh·∫≠t key
                localStorage.removeItem('selected_user');
                location.reload();
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => { app = new FoodMenuApp(); });
        window.addEventListener('beforeunload', () => { app?.destroy(); });
    </script>
</body>
</html>
