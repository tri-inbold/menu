<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InBold Food Menu - V3</title>    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #1e293b 75%, #0f172a 100%);
            --text-primary: #f8fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --panel-bg: rgba(15, 23, 42, 0.95);
            --panel-border: rgba(148, 163, 184, 0.2);
            --card-shadow: 0 25px 50px -12px rgba(0,0,0,.6), 0 0 0 1px rgba(148,163,184,.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.1) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundPulse 15s ease-in-out infinite;
        }

        @keyframes backgroundPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-content {
            text-align: center;
            padding: 40px;
            background: var(--panel-bg);
            border-radius: 20px;
            border: 1px solid var(--panel-border);
            box-shadow: var(--card-shadow);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--text-muted);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 18px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        /* Header */
        .app-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .app-title {
            font-size: 36px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .app-subtitle {
            color: var(--text-muted);
            font-size: 16px;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: var(--panel-bg);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 40px;
            border: 1px solid var(--panel-border);
            box-shadow: var(--card-shadow);
            justify-content: center;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 40px;
        }

        .nav-tab {
            flex: 1;
            padding: 16px 24px;
            background: transparent;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .nav-tab.active {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 8px 25px -8px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-secondary);
        }

        /* Content Areas */
        .content-area {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .content-area.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Today Mode */
        .today-section {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .user-selector {
            background: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }

        .user-select {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            background: transparent;
            border: 2px solid var(--panel-border);
            border-radius: 12px;
            color: var(--text-primary);
            outline: none;
            appearance: none;
            cursor: pointer;
            font-weight: 500;
            text-align: center;
        }

        .user-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .today-info {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
        }

        .today-greeting {
            font-size: 20px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .user-name {
            font-weight: 700;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dish-name {
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 20px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-eaten {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-not-eaten {
            background: rgba(107, 114, 128, 0.2);
            color: var(--text-muted);
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .action-button {
            width: 100%;
            max-width: 300px;
            padding: 18px 32px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-eaten {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4);
        }

        .btn-eaten:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -5px rgba(16, 185, 129, 0.5);
        }

        .btn-undo {
            background: var(--warning-gradient);
            color: white;
            box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.4);
        }

        .btn-undo:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -5px rgba(245, 158, 11, 0.5);
        }

        .action-button:disabled {
            background: linear-gradient(135deg, #64748b 0%, #94a3b8 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Menu Mode */
        .menu-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 16px;
            background: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 12px;
            color: var(--text-primary);
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .filter-button {
            padding: 16px 20px;
            background: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            min-width: 120px;
        }

        .filter-button:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .menu-table-container {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .menu-table {
            width: 100%;
            border-collapse: collapse;
        }

        .menu-table th {
            background: rgba(59, 130, 246, 0.1);
            padding: 20px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 16px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .menu-table th:first-child {
            width: 80px;
            text-align: center;
        }

        .menu-table td {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .menu-table td:first-child {
            text-align: center;
        }

        .menu-table tr {
            transition: all 0.2s ease;
        }

        .menu-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .menu-table tr.eaten {
            opacity: 0.6;
            background: rgba(16, 185, 129, 0.05);
        }

        .checkbox-custom {
            width: 20px;
            height: 20px;
            accent-color: #10b981;
            cursor: pointer;
        }

        /* About Mode */
        .about-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .about-card {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }

        .about-title {
            font-size: 24px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .feature-list {
            list-style: none;
            padding: 0;
        }

        .feature-list li {
            padding: 12px 0;
            padding-left: 32px;
            color: var(--text-secondary);
            position: relative;
            line-height: 1.6;
        }

        .feature-list li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: 700;
            font-size: 18px;
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .btn-secondary {
            padding: 14px 28px;
            background: var(--panel-bg);
            border: 2px solid var(--panel-border);
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger-gradient);
            border-color: transparent;
            color: white;
            box-shadow: 0 8px 25px -8px rgba(239, 68, 68, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px -8px rgba(239, 68, 68, 0.5);
        }

        /* Status Messages */
        .status-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.2);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .status-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                padding: 16px;
            }

            .app-title {
                font-size: 28px;
            }

            .nav-tabs {
                max-width: none;
            }

            .nav-tab {
                padding: 12px 16px;
                font-size: 14px;
            }

            .dish-name {
                font-size: 24px;
            }

            .menu-controls {
                flex-direction: column;
            }

            .search-box {
                min-width: auto;
            }

            .menu-table th,
            .menu-table td {
                padding: 12px 16px;
                font-size: 14px;
            }

            .about-card {
                padding: 24px;
            }

            .action-buttons {
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .app-title {
                font-size: 24px;
            }

            .today-info {
                padding: 24px;
            }

            .dish-name {
                font-size: 20px;
            }

            .action-button {
                max-width: none;
            }
        }

        /* Scroll Styling */
        .menu-table-container {
            max-height: 60vh;
            overflow-y: auto;
        }

        .menu-table-container::-webkit-scrollbar {
            width: 8px;
        }

        .menu-table-container::-webkit-scrollbar-track {
            background: rgba(148, 163, 184, 0.1);
            border-radius: 4px;
        }

        .menu-table-container::-webkit-scrollbar-thumb {
            background: var(--accent-gradient);
            border-radius: 4px;
        }

        .menu-table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">ƒêang kh·ªüi t·∫°o...</div>
        </div>
    </div>

    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">InBold Food Menu</h1>
            <p class="app-subtitle">H·ªá th·ªëng qu·∫£n l√Ω th·ª±c ƒë∆°n th√¥ng minh</p>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="today">H√¥m nay</button>
            <button class="nav-tab" data-tab="menu">Menu</button>
            <button class="nav-tab" data-tab="about">Th√¥ng tin</button>
        </nav>

        <!-- Today Tab -->
        <div id="today-content" class="content-area active">
            <div class="today-section">
                <div class="user-selector">
                    <select id="user-select" class="user-select">
                        <option value="">-- Ch·ªçn t√™n c·ªßa b·∫°n --</option>
                    </select>
                </div>

                <div class="today-info">
                    <p class="today-greeting" id="today-greeting">
                        Ch√†o b·∫°n, vui l√≤ng ch·ªçn t√™n ƒë·ªÉ xem th·ª±c ƒë∆°n h√¥m nay
                    </p>
                    <h2 class="dish-name" id="dish-name">üçΩÔ∏è</h2>
                    <div class="status-indicator status-not-eaten" id="eaten-status">
                        <span>‚è≥</span>
                        <span>Ch∆∞a ƒÉn</span>
                    </div>
                </div>

                <button id="action-button" class="action-button btn-eaten" disabled>
                    ƒê√°nh d·∫•u ƒë√£ ƒÉn
                </button>

                <div id="status-message" class="status-message status-success hidden">
                    C·∫≠p nh·∫≠t th√†nh c√¥ng!
                </div>
            </div>
        </div>

        <!-- Menu Tab -->
        <div id="menu-content" class="content-area">
            <div class="menu-controls">
                <div class="search-box">
                    <input type="text" id="menu-search" class="search-input" placeholder="T√¨m ki·∫øm t√™n nh√¢n vi√™n...">
                </div>
                <button id="shift-filter" class="filter-button">T·∫•t c·∫£ ca</button>
            </div>

            <div class="menu-table-container">
                <table class="menu-table">
                    <thead id="menu-thead">
                        <tr>
                            <th>Tr·∫°ng th√°i</th>
                            <th>T√™n nh√¢n vi√™n</th>
                            <th>Ca l√†m</th>
                            <th id="today-column">H√¥m nay</th>
                        </tr>
                    </thead>
                    <tbody id="menu-tbody">
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                ƒêang t·∫£i d·ªØ li·ªáu...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- About Tab -->
        <div id="about-content" class="content-area">
            <div class="about-container">
                <div class="about-card">
                    <h3 class="about-title">T√≠nh nƒÉng ch√≠nh</h3>
                    <ul class="feature-list">
                        <li>Xem m√≥n ƒÉn theo ng√†y trong tu·∫ßn</li>
                        <li>ƒê√°nh d·∫•u tr·∫°ng th√°i ƒë√£ ƒÉn/ch∆∞a ƒÉn</li>
                        <li>T√¨m ki·∫øm v√† l·ªçc nh√¢n vi√™n theo ca</li>
                        <li>C·∫≠p nh·∫≠t real-time qua Google Sheets</li>
                        <li>Giao di·ªán responsive cho mobile</li>
                        <li>L∆∞u tr·ªØ t·ª± ƒë·ªông th√¥ng tin ng∆∞·ªùi d√πng</li>
                    </ul>
                </div>

                <div class="about-card">
                    <h3 class="about-title">H·ªó tr·ª£</h3>
                    <div class="action-buttons">
                        <button id="clear-cache" class="btn-secondary btn-danger">X√≥a b·ªô nh·ªõ t·∫°m</button>
                        <a href="mailto:tri.vu.trong@inbold.com" class="btn-secondary">Li√™n h·ªá h·ªó tr·ª£</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class InBoldFoodApp {
            constructor() {
                // Configuration
                this.SHEET_ID = '11mnJvKd0T-HPMjO5Rf1B6zAn3cMGbbi9dcfWevCUB9g';
                this.API_KEY = 'AIzaSyDypKkzhsZ_aai6YozkoP4cywXSW1z_vvc';
                this.APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzAg-wyFFGuD45qoWpG5IegkdmzZJZgSApRCfazTI7NzxAJ851f7imGOpRKPNXY9elD/exec';
                this.SHEET_NAME = 'Sheet1';
                this.CACHE_KEY = 'inbold_food_menu_v3';
                this.USER_KEY = 'selected_user_v3';
                
                // State
                this.allUsersData = [];
                this.selectedUser = null;
                this.currentTab = 'today';
                this.shiftFilter = 'all'; // all, day, evening
                this.updateInterval = null;
                
                // DOM Elements
                this.loadingOverlay = document.getElementById('loading-overlay');
                this.loadingText = document.getElementById('loading-text');
                this.userSelect = document.getElementById('user-select');
                this.todayGreeting = document.getElementById('today-greeting');
                this.dishName = document.getElementById('dish-name');
                this.eatenStatus = document.getElementById('eaten-status');
                this.actionButton = document.getElementById('action-button');
                this.statusMessage = document.getElementById('status-message');
                this.menuSearch = document.getElementById('menu-search');
                this.shiftFilterBtn = document.getElementById('shift-filter');
                this.menuTbody = document.getElementById('menu-tbody');
                this.todayColumn = document.getElementById('today-column');
                
                this.init();
            }
            
            async init() {
                try {
                    this.setupEventListeners();
                    this.updateLoadingText('ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...');
                    await this.loadData();
                    this.populateUserSelect();
                    this.loadSavedUser();
                    this.updateTodayView();
                    this.updateMenuView();
                    this.startAutoUpdate();
                    this.hideLoading();
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.updateLoadingText(`L·ªói kh·ªüi t·∫°o: ${error.message}`);
                }
            }
            
            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });
                
                // User selection
                this.userSelect.addEventListener('change', (e) => {
                    this.handleUserSelection(e.target.value);
                });
                
                // Action button
                this.actionButton.addEventListener('click', () => {
                    this.toggleEatenStatus();
                });
                
                // Menu search
                this.menuSearch.addEventListener('input', () => {
                    this.updateMenuView();
                });
                
                // Shift filter
                this.shiftFilterBtn.addEventListener('click', () => {
                    this.toggleShiftFilter();
                });
                
                // Clear cache button
                document.getElementById('clear-cache').addEventListener('click', () => {
                    this.clearCache();
                });
            }
            
            async loadData() {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${this.SHEET_ID}/values/${this.SHEET_NAME}?key=${this.API_KEY}`;
                
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Google Sheets API l·ªói: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.values || data.values.length < 2) {
                        throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu trong sheet');
                    }
                    
                    const headers = data.values[0];
                    const rows = data.values.slice(1);
                    
                    this.allUsersData = rows.map(row => {
                        const user = {};
                        headers.forEach((header, index) => {
                            user[header] = row[index] || '';
                        });
                        return user;
                    }).filter(user => user['T√™n'] && user['T√™n'].trim() !== '');
                    
                    // Cache data
                    localStorage.setItem(this.CACHE_KEY, JSON.stringify(this.allUsersData));
                    console.log(`Loaded ${this.allUsersData.length} users from Google Sheets`);
                    
                } catch (error) {
                    console.error('Failed to load from Google Sheets:', error);
                    
                    // Try to load from cache
                    const cachedData = localStorage.getItem(this.CACHE_KEY);
                    if (cachedData) {
                        this.allUsersData = JSON.parse(cachedData);
                        console.warn('Loaded data from cache due to API error');
                        this.showStatusMessage('ƒêang s·ª≠ d·ª•ng d·ªØ li·ªáu cache do l·ªói k·∫øt n·ªëi', 'warning');
                    } else {
                        throw new Error(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}`);
                    }
                }
            }
            
            populateUserSelect() {
                this.userSelect.innerHTML = '<option value="">-- Ch·ªçn t√™n c·ªßa b·∫°n --</option>';
                
                const sortedUsers = this.allUsersData
                    .sort((a, b) => (a['T√™n'] || '').replace('‚Ä¢ ', '').localeCompare((b['T√™n'] || '').replace('‚Ä¢ ', '')));
                    
                sortedUsers.forEach(user => {
                    const option = document.createElement('option');
                    const userName = (user['T√™n'] || '').replace('‚Ä¢ ', '');
                    option.value = userName;
                    option.textContent = userName;
                    this.userSelect.appendChild(option);
                });
            }
            
            loadSavedUser() {
                const savedUser = localStorage.getItem(this.USER_KEY);
                if (savedUser && this.userSelect.querySelector(`option[value="${savedUser}"]`)) {
                    this.userSelect.value = savedUser;
                    this.handleUserSelection(savedUser);
                }
            }
            
            handleUserSelection(userName) {
                if (userName) {
                    this.selectedUser = this.allUsersData.find(u => 
                        (u['T√™n'] || '').replace('‚Ä¢ ', '') === userName
                    );
                    localStorage.setItem(this.USER_KEY, userName);
                } else {
                    this.selectedUser = null;
                    localStorage.removeItem(this.USER_KEY);
                }
                
                this.updateTodayView();
            }
            
            updateTodayView() {
                const today = new Date().getDay();
                const dayNames = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
                const currentDay = dayNames[today];
                
                if (this.selectedUser) {
                    const userName = (this.selectedUser['T√™n'] || '').replace('‚Ä¢ ', '');
                    const dish = this.selectedUser[currentDay] || 'Kh√¥ng c√≥ th√¥ng tin';
                    const hasEaten = this.hasUserEaten(this.selectedUser);
                    
                    this.todayGreeting.innerHTML = `Ch√†o <span class="user-name">${userName}</span>, h√¥m nay b·∫°n ƒÉn:`;
                    this.dishName.textContent = dish;
                    
                    // Update status indicator
                    this.eatenStatus.className = `status-indicator ${hasEaten ? 'status-eaten' : 'status-not-eaten'}`;
                    this.eatenStatus.innerHTML = hasEaten 
                        ? '<span>‚úÖ</span><span>ƒê√£ ƒÉn</span>'
                        : '<span>‚è≥</span><span>Ch∆∞a ƒÉn</span>';
                    
                    // Update action button
                    this.actionButton.disabled = false;
                    this.actionButton.className = `action-button ${hasEaten ? 'btn-undo' : 'btn-eaten'}`;
                    this.actionButton.textContent = hasEaten ? 'Ho√†n t√°c' : 'ƒê√£ ƒÉn';
                    
                } else {
                    this.todayGreeting.textContent = 'Ch√†o b·∫°n, vui l√≤ng ch·ªçn t√™n ƒë·ªÉ xem th·ª±c ƒë∆°n h√¥m nay';
                    this.dishName.textContent = 'üçΩÔ∏è';
                    this.eatenStatus.className = 'status-indicator status-not-eaten';
                    this.eatenStatus.innerHTML = '<span>‚è≥</span><span>Ch∆∞a ch·ªçn ng∆∞·ªùi d√πng</span>';
                    this.actionButton.disabled = true;
                    this.actionButton.className = 'action-button btn-eaten';
                    this.actionButton.textContent = 'ƒê√°nh d·∫•u ƒë√£ ƒÉn';
                }
            }
            
            hasUserEaten(user) {
                const name = user['T√™n'] || '';
                const eaten = user['Eaten'] || '';
                return name.startsWith('‚Ä¢ ') || (eaten && eaten.trim() !== '');
            }
            
            async toggleEatenStatus() {
                if (!this.selectedUser) return;
                
                const userName = (this.selectedUser['T√™n'] || '').replace('‚Ä¢ ', '');
                const hasEaten = this.hasUserEaten(this.selectedUser);
                const newStatus = !hasEaten;
                
                this.actionButton.disabled = true;
                this.actionButton.textContent = 'ƒêang c·∫≠p nh·∫≠t...';
                
                try {
                    await this.updateEatenStatus(userName, newStatus);
                    
                    // Update local data
                    if (newStatus) {
                        this.selectedUser['T√™n'] = '‚Ä¢ ' + userName;
                        this.selectedUser['Eaten'] = new Date().toISOString();
                    } else {
                        this.selectedUser['T√™n'] = userName;
                        this.selectedUser['Eaten'] = '';
                    }
                    
                    this.updateTodayView();
                    this.updateMenuView();
                    this.showStatusMessage('C·∫≠p nh·∫≠t th√†nh c√¥ng!', 'success');
                    
                } catch (error) {
                    console.error('Update error:', error);
                    this.showStatusMessage(`L·ªói c·∫≠p nh·∫≠t: ${error.message}`, 'error');
                    this.updateTodayView(); // Reset button state
                }
            }
            
            async updateEatenStatus(userName, isEaten) {
                const response = await fetch(this.APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userName: userName,
                        isEaten: isEaten
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                if (result.status !== 'success') {
                    throw new Error(result.message || 'Unknown error');
                }
                
                return result;
            }
            
            updateMenuView() {
                const today = new Date().getDay();
                const dayNames = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
                const currentDay = dayNames[today];
                
                // Update column header
                this.todayColumn.textContent = currentDay;
                
                // Filter data
                const filteredData = this.getFilteredData();
                
                // Render table
                if (filteredData.length === 0) {
                    this.menuTbody.innerHTML = `
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">
                                Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const rows = filteredData.map(user => {
                    const userName = (user['T√©n'] || '').replace('‚Ä¢ ', '');
                    const shift = user['Ca'] || '';
                    const dish = user[currentDay] || '';
                    const hasEaten = this.hasUserEaten(user);
                    
                    return `
                        <tr class="${hasEaten ? 'eaten' : ''}" data-user="${userName}">
                            <td>
                                <input type="checkbox" 
                                       class="checkbox-custom" 
                                       ${hasEaten ? 'checked' : ''} 
                                       onchange="app.handleCheckboxChange('${userName}', this.checked)">
                            </td>
                            <td>${userName}</td>
                            <td>${this.formatShift(shift)}</td>
                            <td>${dish}</td>
                        </tr>
                    `;
                }).join('');
                
                this.menuTbody.innerHTML = rows;
            }
            
            getFilteredData() {
                const searchTerm = this.menuSearch.value.toLowerCase().trim();
                
                return this.allUsersData.filter(user => {
                    // Search filter
                    if (searchTerm) {
                        const userName = ((user['T√™n'] || '').replace('‚Ä¢ ', '')).toLowerCase();
                        const normalizedName = this.removeVietnameseDiacritics(userName);
                        const normalizedSearch = this.removeVietnameseDiacritics(searchTerm);
                        
                        if (!userName.includes(searchTerm) && !normalizedName.includes(normalizedSearch)) {
                            return false;
                        }
                    }
                    
                    // Shift filter
                    if (this.shiftFilter !== 'all') {
                        const userShift = user['Ca'] || '';
                        if (this.shiftFilter === 'day' && !userShift.includes('Day')) {
                            return false;
                        }
                        if (this.shiftFilter === 'evening' && !userShift.includes('Evening')) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }
            
            formatShift(shift) {
                if (shift.includes('Day')) return 'üåÖ Ca s√°ng';
                if (shift.includes('Evening')) return 'üåá Ca chi·ªÅu';
                return shift;
            }
            
            removeVietnameseDiacritics(str) {
                return str.normalize('NFD')
                         .replace(/[\u0300-\u036f]/g, '')
                         .replace(/ƒë/g, 'd')
                         .replace(/ƒê/g, 'D');
            }
            
            async handleCheckboxChange(userName, isChecked) {
                const user = this.allUsersData.find(u => 
                    (u['T√™n'] || '').replace('‚Ä¢ ', '') === userName
                );
                
                if (!user) return;
                
                try {
                    await this.updateEatenStatus(userName, isChecked);
                    
                    // Update local data
                    if (isChecked) {
                        user['T√™n'] = '‚Ä¢ ' + userName;
                        user['Eaten'] = new Date().toISOString();
                    } else {
                        user['T√™n'] = userName;
                        user['Eaten'] = '';
                    }
                    
                    // Update views if this is the selected user
                    if (this.selectedUser && (this.selectedUser['T√™n'] || '').replace('‚Ä¢ ', '') === userName) {
                        this.selectedUser = user;
                        this.updateTodayView();
                    }
                    
                    // Update the row appearance
                    const row = document.querySelector(`tr[data-user="${userName}"]`);
                    if (row) {
                        row.classList.toggle('eaten', isChecked);
                    }
                    
                } catch (error) {
                    console.error('Checkbox update error:', error);
                    
                    // Reset checkbox on error
                    const checkbox = document.querySelector(`tr[data-user="${userName}"] input[type="checkbox"]`);
                    if (checkbox) {
                        checkbox.checked = !isChecked;
                    }
                    
                    this.showStatusMessage(`L·ªói c·∫≠p nh·∫≠t: ${error.message}`, 'error');
                }
            }
            
            toggleShiftFilter() {
                const filters = ['all', 'day', 'evening'];
                const labels = ['T·∫•t c·∫£ ca', 'Ca s√°ng', 'Ca chi·ªÅu'];
                
                const currentIndex = filters.indexOf(this.shiftFilter);
                const nextIndex = (currentIndex + 1) % filters.length;
                
                this.shiftFilter = filters[nextIndex];
                this.shiftFilterBtn.textContent = labels[nextIndex];
                
                this.updateMenuView();
            }
            
            switchTab(tabName) {
                this.currentTab = tabName;
                
                // Update tab buttons
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                
                // Update content areas
                document.querySelectorAll('.content-area').forEach(area => {
                    area.classList.remove('active');
                });
                document.getElementById(`${tabName}-content`).classList.add('active');
                
                // Update menu view when switching to menu tab
                if (tabName === 'menu') {
                    this.updateMenuView();
                }
            }
            
            showStatusMessage(message, type = 'success') {
                this.statusMessage.textContent = message;
                this.statusMessage.className = `status-message status-${type}`;
                this.statusMessage.classList.remove('hidden');
                
                setTimeout(() => {
                    this.statusMessage.classList.add('hidden');
                }, 3000);
            }
            
            startAutoUpdate() {
                // Auto-refresh data every 2 minutes
                this.updateInterval = setInterval(async () => {
                    try {
                        await this.loadData();
                        this.populateUserSelect();
                        
                        // Restore selected user
                        const currentSelection = this.userSelect.value;
                        if (currentSelection) {
                            this.handleUserSelection(currentSelection);
                        }
                        
                        if (this.currentTab === 'menu') {
                            this.updateMenuView();
                        }
                        
                        console.log('Auto-update completed');
                    } catch (error) {
                        console.warn('Auto-update failed:', error);
                    }
                }, 120000); // 2 minutes
            }
            
            clearCache() {
                if (confirm('X√≥a b·ªô nh·ªõ t·∫°m s·∫Ω t·∫£i l·∫°i d·ªØ li·ªáu m·ªõi t·ª´ Google Sheets. B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                    localStorage.removeItem(this.CACHE_KEY);
                    localStorage.removeItem(this.USER_KEY);
                    location.reload();
                }
            }
            
            clearCache() {
                if (confirm('X√≥a b·ªô nh·ªõ t·∫°m s·∫Ω t·∫£i l·∫°i d·ªØ li·ªáu m·ªõi t·ª´ Google Sheets. B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                    localStorage.removeItem(this.CACHE_KEY);
                    localStorage.removeItem(this.USER_KEY);
                    location.reload();
                }
            }
            
            hideLoading() {
                this.loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    this.loadingOverlay.classList.add('hidden');
                }, 500);
            }
            
            destroy() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                }
            }
        }
        
        // Initialize app
        let app;
        
        document.addEventListener('DOMContentLoaded', () => {
            app = new InBoldFoodApp();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (app) {
                app.destroy();
            }
        });
    </script>
</body>
</html>
