<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InBold Menu</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root{--bg-primary:#111827;--bg-secondary:#1f2937;--bg-tertiary:#374151;--text-primary:#f9fafb;--text-secondary:#d1d5db;--text-muted:#9ca3af;--accent-primary:#3b82f6;--accent-secondary:#6366f1;--accent-gradient:linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--border-color:rgba(156, 163, 175, 0.2);--shadow-sm:0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);--shadow-md:0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1)}*{margin:0;padding:0;box-sizing:border-box}html{-webkit-tap-highlight-color:transparent}body{font-family:'Be Vietnam Pro',sans-serif;background-color:var(--bg-primary);color:var(--text-primary);height:100vh;height:100dvh;display:flex;flex-direction:column;overflow:hidden;position:fixed;width:100%}.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(17, 24, 39, 0.95);backdrop-filter:blur(10px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;transition:opacity 0.3s ease}.loading-overlay.hidden{opacity:0;pointer-events:none}.spinner{width:56px;height:56px;border:6px solid var(--border-color);border-top-color:var(--accent-primary);border-radius:50%;animation:spin 1s linear infinite}.loading-text{margin-top:20px;font-weight:500;color:var(--text-secondary);font-size:16px;text-align:center;padding:0 20px}@keyframes spin{to{transform:rotate(360deg)}}.app-container{display:flex;flex-direction:column;height:100%;max-width:1200px;margin:0 auto;width:100%}.app-header{padding:12px 16px;display:flex;justify-content:center;background:rgba(31, 41, 55, 0.8);backdrop-filter:blur(12px);border-bottom:1px solid var(--border-color)}.nav-tabs{display:flex;background:var(--bg-primary);border-radius:18px;padding:6px;border:1px solid var(--border-color)}.nav-tab{padding:12px 24px;background:transparent;border:none;border-radius:14px;font-size:15px;font-weight:600;color:var(--text-muted);cursor:pointer;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);position:relative}.nav-tab.active{background:var(--accent-gradient);color:var(--text-primary);box-shadow:var(--shadow-md)}.nav-tab.highlight::after{content:'';position:absolute;top:10px;right:18px;width:8px;height:8px;background:var(--warning);border-radius:50%;animation:pulse 1.5s infinite}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(245, 158, 11, 0.7)}70%{box-shadow:0 0 0 10px rgba(245, 158, 11, 0)}100%{box-shadow:0 0 0 0 rgba(245, 158, 11, 0)}}.app-content{flex:1;overflow-y:auto;display:flex;flex-direction:column}.tab-pane{display:none;padding:24px 16px;animation:fadeIn 0.4s ease;height:100%}.tab-pane.active{display:flex;flex-direction:column}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.menu-controls{display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap}.search-bar{flex-grow:1;position:relative}.search-bar input{width:100%;padding:14px 18px 14px 48px;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;color:var(--text-primary);font-size:15px;outline:none;transition:all 0.2s ease}.search-bar input:focus{border-color:var(--accent-primary);box-shadow:0 0 0 3px rgba(59, 130, 246, 0.2)}.search-bar .search-icon{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--text-muted);pointer-events:none}.filter-buttons{display:flex;background:var(--bg-secondary);border-radius:12px;padding:5px;border:1px solid var(--border-color)}.filter-btn{padding:8px 16px;background:transparent;border:none;border-radius:8px;color:var(--text-muted);cursor:pointer;transition:all 0.2s ease;font-weight:600;display:flex;align-items:center;gap:6px}.filter-btn.active{background:var(--bg-tertiary);color:var(--text-primary)}.menu-table-container{flex:1;overflow-y:auto;border:1px solid var(--border-color);border-radius:16px;background:var(--bg-secondary)}.menu-table{width:100%;border-collapse:collapse}.menu-table th,.menu-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border-color)}.menu-table th{background:rgba(31, 41, 55, 0.9);backdrop-filter:blur(5px);position:sticky;top:0;font-weight:700;font-size:14px;color:var(--text-secondary)}.menu-table th .sort-icon{opacity:0.5;transition:opacity 0.2s}.menu-table th:hover .sort-icon{opacity:1}.menu-table th.sorted .sort-icon{opacity:1;color:var(--accent-primary)}.menu-table tr.group-header td{background-color:var(--bg-tertiary);font-weight:700;color:var(--text-primary);padding:10px 16px;font-size:16px}.menu-table td{font-size:15px;font-weight:500;transition:opacity 0.3s,filter 0.3s}.menu-table tr.checked-row td{opacity:0.5;filter:blur(1px)}.menu-table tr:last-child td{border-bottom:none}.menu-table .checkbox-cell{width:50px}.menu-table input[type=checkbox]{width:20px;height:20px;accent-color:var(--accent-primary)}#today-pane{justify-content:center;align-items:center;text-align:center}.today-card{background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:20px;padding:32px;width:100%;max-width:500px;box-shadow:var(--shadow-md)}.user-selector-container{margin-bottom:24px}.user-selector-container select{width:100%;padding:14px 18px;background:var(--bg-tertiary);border:1px solid var(--border-color);border-radius:12px;color:var(--text-primary);font-size:16px;font-weight:600;outline:none}.greeting{font-size:20px;color:var(--text-secondary);margin-bottom:8px}.today-meal{font-size:28px;font-weight:800;margin-bottom:32px;min-height:40px;background:var(--accent-gradient);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.eaten-btn{width:100%;padding:16px;background:var(--accent-gradient);border:none;border-radius:12px;color:var(--text-primary);font-size:18px;font-weight:700;cursor:pointer;transition:all 0.2s ease}.eaten-btn:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(59, 130, 246, 0.3)}.eaten-btn:disabled{background:var(--bg-tertiary);cursor:not-allowed;color:var(--text-muted);box-shadow:none;transform:none}.eaten-btn:disabled .icon{margin-right:8px}#order-pane{gap:24px}.order-info{background:var(--bg-secondary);border-radius:16px;padding:20px;text-align:center;font-weight:600}.order-info .week-label{color:var(--accent-primary)}.order-table-container{flex:1;overflow-y:auto;border:1px solid var(--border-color);border-radius:16px;background:var(--bg-secondary)}.order-table{width:100%;border-collapse:collapse}.order-table th,.order-table td{padding:16px;text-align:left;border-bottom:1px solid var(--border-color)}.order-table th{position:sticky;top:0;background:rgba(31, 41, 55, 0.9);backdrop-filter:blur(5px);font-size:14px;color:var(--text-secondary)}.order-table td:first-child{font-weight:600}.order-table tr:last-child td{border-bottom:none}.hidden{display:none!important}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg-tertiary);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--accent-secondary)}@media (max-width:768px){.nav-tab{padding:12px 16px;font-size:14px}.tab-pane{padding:16px}.menu-controls{flex-direction:column}.greeting{font-size:18px}.today-meal{font-size:24px}}
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay"><div class="spinner"></div><p class="loading-text">ƒêang kh·ªüi t·∫°o ·ª©ng d·ª•ng...</p></div>
    <div id="app-container" class="app-container">
        <header class="app-header"><nav id="nav-tabs" class="nav-tabs"><button class="nav-tab" data-tab="menu-pane">Menu</button><button class="nav-tab active" data-tab="today-pane">H√¥m nay</button><button class="nav-tab" data-tab="order-pane">ƒê·∫∑t m√≥n</button></nav></header>
        <main class="app-content"><section id="menu-pane" class="tab-pane"></section><section id="today-pane" class="tab-pane active"></section><section id="order-pane" class="tab-pane"></section></main>
    </div>
    <template id="menu-template"><div class="menu-controls"><div class="search-bar"><span class="search-icon"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span><input type="text" id="search-input" placeholder="T√¨m ki·∫øm theo t√™n..."></div><div class="filter-buttons"><button class="filter-btn active" data-shift="all"><span>T·∫•t c·∫£</span></button><button class="filter-btn" data-shift="S√°ng"><span>S√°ng</span></button><button class="filter-btn" data-shift="Chi·ªÅu"><span>Chi·ªÅu</span></button></div></div><div class="menu-table-container"><table class="menu-table"><thead><tr><th class="checkbox-cell"></th><th id="sort-by-name">T√™n <svg class="sort-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 16 4 4 4-4"></path><path d="M7 20V4"></path><path d="m21 8-4-4-4 4"></path><path d="M17 4v16"></path></svg></th><th id="today-column-header">H√¥m nay</th></tr></thead><tbody id="menu-table-body"></tbody></table></div></template>
    <template id="today-template"><div class="today-card"><div class="user-selector-container"><select id="user-selector"></select></div><p class="greeting">Ch√†o <span id="user-name-placeholder">b·∫°n</span>, h√¥m nay b·∫°n ƒÉn:</p><h2 id="today-meal" class="today-meal">...</h2><button id="eaten-btn" class="eaten-btn"><span class="icon"></span> ƒê√£ ƒÉn</button></div></template>
    <template id="order-template"><div id="order-info" class="order-info">Xem th·ª±c ƒë∆°n cho tu·∫ßn <span class="week-label" id="order-week-label">...</span>.</div><div class="order-table-container"><table id="order-table-vi" class="order-table"></table></div><div class="order-table-container"><table id="order-table-en" class="order-table"></table></div></template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const InBoldMenuApp = {
            CONFIG: {
                // !!! QUAN TR·ªåNG: D√ÅN URL M·ªöI NH·∫§T B·∫†N NH·∫¨N ƒê∆Ø·ª¢C ·ªû B∆Ø·ªöC 2 V√ÄO ƒê√ÇY
                APPS_SCRIPT_URL: 'D√ÅN_URL_M·ªöI_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY',
            },
            STATE: { allSheetData: [], currentUser: null, currentWeekSheetName: '', todayColumnIndex: -1, todayColumnHeader: '', sortState: { column: 'T√™n', order: 'asc' } },
            UI: {},
            
            init() {
                if (this.CONFIG.APPS_SCRIPT_URL === 'D√ÅN_URL_M·ªöI_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY' || this.CONFIG.APPS_SCRIPT_URL === '') {
                    alert('L·ªñI C·∫§U H√åNH: Vui l√≤ng d√°n URL Google Apps Script v√†o file HTML.');
                    this.showLoading('L·ªói c·∫•u h√¨nh!');
                    return;
                }
                this.loadTemplatesIntoPanes();
                this.cacheDOMElements();
                this.setupEventListeners();
                this.startApp();
            },
            
            loadTemplatesIntoPanes() {
                document.getElementById('menu-pane').innerHTML = document.getElementById('menu-template').innerHTML;
                document.getElementById('today-pane').innerHTML = document.getElementById('today-template').innerHTML;
                document.getElementById('order-pane').innerHTML = document.getElementById('order-template').innerHTML;
            },
            
            cacheDOMElements() {
                this.UI = { loading: document.getElementById('loading'), loadingText: document.querySelector('.loading-text'), navTabs: document.getElementById('nav-tabs'), tabPanes: document.querySelectorAll('.tab-pane'), menuTableBody: document.getElementById('menu-table-body'), searchInput: document.getElementById('search-input'), filterButtons: document.querySelectorAll('.filter-btn'), todayColumnHeader: document.getElementById('today-column-header'), sortByNameHeader: document.getElementById('sort-by-name'), userSelector: document.getElementById('user-selector'), userNamePlaceholder: document.getElementById('user-name-placeholder'), todayMealDisplay: document.getElementById('today-meal'), eatenBtn: document.getElementById('eaten-btn'), orderWeekLabel: document.getElementById('order-week-label'), orderTableVi: document.getElementById('order-table-vi'), orderTableEn: document.getElementById('order-table-en'), orderTab: document.querySelector('.nav-tab[data-tab="order-pane"]') };
            },

            showLoading(message) { this.UI.loadingText.textContent = message; this.UI.loading.classList.remove('hidden'); },
            hideLoading() { this.UI.loading.classList.add('hidden'); },
            
            async startApp() {
                this.showLoading('ƒêang t·∫£i d·ªØ li·ªáu th·ª±c ƒë∆°n...');
                try {
                    this.calculateCurrentWeek();
                    const menuData = await this.fetchSheetData(this.STATE.currentWeekSheetName);
                    if (menuData.length === 0) { throw new Error(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho tu·∫ßn '${this.STATE.currentWeekSheetName}'.`); }
                    this.STATE.allSheetData = menuData;
                    
                    this.populateUserSelector();
                    this.renderMenuTable();
                    this.updateTodayView();
                    
                    this.showLoading('ƒêang t·∫£i th·ª±c ƒë∆°n ƒë·∫∑t m√≥n...');
                    await this.renderOrderTab();

                } catch (error) {
                    console.error('L·ªói khi kh·ªüi ƒë·ªông:', error);
                    alert(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ${error.message}. Vui l√≤ng ki·ªÉm tra l·∫°i URL v√† k·∫øt n·ªëi m·∫°ng.`);
                    this.showLoading(`L·ªói: ${error.message}`);
                } finally {
                    this.hideLoading();
                }
            },
            
            async apiFetch(endpoint, method = 'GET', body = null) {
                const url = this.CONFIG.APPS_SCRIPT_URL + endpoint;
                const options = { method, redirect: 'follow' };
                if (method === 'POST') {
                    options.body = JSON.stringify(body);
                    options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
                }
                const response = await fetch(url, options);
                if (!response.ok) { throw new Error(`L·ªói m·∫°ng: ${response.statusText}`); }
                const result = await response.json();
                if (!result.success) { throw new Error(result.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh t·ª´ API.'); }
                return result.data;
            },

            async fetchSheetData(sheetName) { return this.apiFetch(`?action=getSheetData&sheetName=${encodeURIComponent(sheetName)}`); },
            async updateCell(sheetName, range, value) { return this.apiFetch('', 'POST', { sheetName, range, value }); },

            setupEventListeners() {
                this.UI.navTabs.addEventListener('click', (e) => { if (e.target.matches('.nav-tab')) this.switchTab(e.target.dataset.tab); });
                this.UI.searchInput.addEventListener('input', () => this.renderMenuTable());
                this.UI.filterButtons.forEach(btn => { btn.addEventListener('click', () => { this.UI.filterButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active'); this.renderMenuTable(); }); });
                this.UI.sortByNameHeader.addEventListener('click', () => this.toggleSort());
                this.UI.userSelector.addEventListener('change', (e) => this.updateTodayView(e.target.value));
                this.UI.eatenBtn.addEventListener('click', () => this.handleMarkAsEatenFromToday());
                document.getElementById('menu-pane').addEventListener('change', (e) => { if (e.target.matches('#menu-table-body input[type="checkbox"]')) { this.handleMarkAsEatenFromMenu(e.target); } });
            },
            
            switchTab(tabId) { this.UI.tabPanes.forEach(pane => pane.classList.remove('active')); document.getElementById(tabId).classList.add('active'); this.UI.navTabs.querySelectorAll('.nav-tab').forEach(tab => { tab.classList.toggle('active', tab.dataset.tab === tabId); }); },
            
            renderMenuTable() {
                const searchText = this.UI.searchInput.value.toLowerCase();
                const activeShift = document.querySelector('.filter-btn.active').dataset.shift;
                let filteredData = this.STATE.allSheetData.filter(user => { const nameMatch = user['T√™n']?.toLowerCase().includes(searchText); const shiftMatch = activeShift === 'all' || user['Ca/shift'] === activeShift; return nameMatch && shiftMatch && user['T√™n']; });
                filteredData.sort((a, b) => { const valA = a[this.STATE.sortState.column] || ''; const valB = b[this.STATE.sortState.column] || ''; return this.STATE.sortState.order === 'asc' ? valA.localeCompare(valB, 'vi') : valB.localeCompare(valA, 'vi'); });
                const uncheckedRows = filteredData.filter(user => !String(user[this.STATE.todayColumnHeader]).startsWith('+'));
                const checkedRows = filteredData.filter(user => String(user[this.STATE.todayColumnHeader]).startsWith('+'));
                let html = '';
                if (activeShift === 'all') {
                    const morningShiftUnchecked = uncheckedRows.filter(u => u['Ca/shift'] === 'S√°ng');
                    const afternoonShiftUnchecked = uncheckedRows.filter(u => u['Ca/shift'] === 'Chi·ªÅu');
                    if (morningShiftUnchecked.length > 0) { html += `<tr class="group-header"><td colspan="3">‚òÄÔ∏è Ca S√°ng - Ch∆∞a nh·∫≠n</td></tr>`; html += morningShiftUnchecked.map(user => this.createUserRowHtml(user)).join(''); }
                    if (afternoonShiftUnchecked.length > 0) { html += `<tr class="group-header"><td colspan="3">üåô Ca Chi·ªÅu - Ch∆∞a nh·∫≠n</td></tr>`; html += afternoonShiftUnchecked.map(user => this.createUserRowHtml(user)).join(''); }
                } else if (uncheckedRows.length > 0) { html += uncheckedRows.map(user => this.createUserRowHtml(user)).join(''); }
                if (checkedRows.length > 0) { html += `<tr class="group-header"><td colspan="3">‚úì ƒê√£ nh·∫≠n</td></tr>`; html += checkedRows.map(user => this.createUserRowHtml(user, true)).join(''); }
                this.UI.menuTableBody.innerHTML = html || '<tr><td colspan="3" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>';
            },

            createUserRowHtml(user, isChecked = false) { const meal = user[this.STATE.todayColumnHeader] || 'N/A'; const cleanMeal = String(meal).startsWith('+') ? String(meal).substring(1) : meal; return `<tr class="${isChecked ? 'checked-row' : ''}" data-row-index="${user.rowIndex}"><td class="checkbox-cell"><input type="checkbox" ${isChecked ? 'checked' : ''} ${!meal || meal === 'N/A' ? 'disabled': ''}></td><td>${user['T√™n']}</td><td>${cleanMeal}</td></tr>`; },
            toggleSort() { this.STATE.sortState.order = this.STATE.sortState.order === 'asc' ? 'desc' : 'asc'; this.UI.sortByNameHeader.classList.add('sorted'); this.renderMenuTable(); },

            populateUserSelector() {
                const users = this.STATE.allSheetData.filter(u => u['T√™n']).sort((a,b) => a['T√™n'].localeCompare(b['T√™n'], 'vi'));
                this.UI.userSelector.innerHTML = users.map(user => `<option value="${user.rowIndex}">${user['T√™n']}</option>`).join('');
                if (users.length > 0) { this.STATE.currentUser = users[0]; }
            },

            updateTodayView(rowIndex = null) {
                if (rowIndex) { this.STATE.currentUser = this.STATE.allSheetData.find(u => u.rowIndex == rowIndex); }
                else if (!this.STATE.currentUser && this.STATE.allSheetData.length > 0) { this.STATE.currentUser = this.STATE.allSheetData.find(u => u['T√™n']); }
                if (!this.STATE.currentUser) return;
                const user = this.STATE.currentUser;
                this.UI.userSelector.value = user.rowIndex;
                this.UI.userNamePlaceholder.textContent = user['T√™n'];
                const meal = user[this.STATE.todayColumnHeader] || 'Kh√¥ng c√≥ l·ªãch';
                const isEaten = String(meal).startsWith('+');
                this.UI.todayMealDisplay.textContent = isEaten ? String(meal).substring(1) : meal;
                this.UI.eatenBtn.disabled = isEaten || !user[this.STATE.todayColumnHeader] || meal === 'Kh√¥ng c√≥ l·ªãch';
                this.UI.eatenBtn.innerHTML = isEaten ? `<span class="icon">‚úì</span> ƒê√£ x√°c nh·∫≠n` : `<span class="icon"></span> ƒê√£ ƒÉn`;
            },
            
            async renderOrderTab() {
                const orderData = await this.apiFetch(`?action=getOrderData`);
                if (!orderData || orderData.length < 1) return;
                const tables = this.parseOrderData(orderData);
                this.UI.orderTableVi.innerHTML = this.createOrderTableHtml(tables.vi);
                this.UI.orderTableEn.innerHTML = this.createOrderTableHtml(tables.en);
                const { isAfterThursday } = this.getDateInfo();
                const targetWeek = this.getWeekNumber(new Date(), isAfterThursday ? 7 : 0);
                this.UI.orderWeekLabel.textContent = `${targetWeek.year}-W${targetWeek.week}`;
            },

            parseOrderData(data) { const tables = { vi: { headers: [], rows: [] }, en: { headers: [], rows: [] } }; let currentTable = null; for (const rowObj of data) { const rowValues = Object.values(rowObj).slice(0, -1); const rowHeaders = Object.keys(rowObj).slice(0, -1); if (rowHeaders[0]?.toLowerCase() === 'm√≥n') { currentTable = 'vi'; tables.vi.headers = rowHeaders; continue; } if (rowHeaders[0]?.toLowerCase() === 'meal') { currentTable = 'en'; tables.en.headers = rowHeaders; continue; } if (currentTable && rowValues.some(cell => String(cell).trim() !== '')) { tables[currentTable].rows.push(rowValues); } } return tables; },
            createOrderTableHtml(data) { if (data.headers.length === 0) return ''; return `<thead><tr>${data.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>`; },
            
            async handleMarkAsEatenFromMenu(checkbox) {
                const row = checkbox.closest('tr');
                const rowIndex = row.dataset.rowIndex;
                const user = this.STATE.allSheetData.find(u => u.rowIndex == rowIndex);
                if (!user) return;
                const currentMeal = user[this.STATE.todayColumnHeader];
                const newMeal = checkbox.checked ? `+${String(currentMeal).replace('+', '')}` : String(currentMeal).replace('+', '');
                this.showLoading('ƒêang c·∫≠p nh·∫≠t...');
                try {
                    const columnLetter = this.columnIndexToLetter(this.STATE.todayColumnIndex);
                    await this.updateCell(this.STATE.currentWeekSheetName, `${columnLetter}${rowIndex}`, newMeal);
                    user[this.STATE.todayColumnHeader] = newMeal;
                    this.renderMenuTable();
                    this.updateTodayView();
                } catch(e) { alert('C·∫≠p nh·∫≠t th·∫•t b·∫°i: ' + e.message); checkbox.checked = !checkbox.checked; }
                finally { this.hideLoading(); }
            },

            async handleMarkAsEatenFromToday() {
                if (!this.STATE.currentUser) return;
                const user = this.STATE.currentUser;
                const currentMeal = user[this.STATE.todayColumnHeader];
                if (!currentMeal || String(currentMeal).startsWith('+')) return;
                const newMeal = `+${currentMeal}`;
                this.showLoading('ƒêang c·∫≠p nh·∫≠t...');
                try {
                    const columnLetter = this.columnIndexToLetter(this.STATE.todayColumnIndex);
                    await this.updateCell(this.STATE.currentWeekSheetName, `${columnLetter}${user.rowIndex}`, newMeal);
                    user[this.STATE.todayColumnHeader] = newMeal;
                    this.updateTodayView();
                    this.renderMenuTable();
                } catch(e) { alert('C·∫≠p nh·∫≠t th·∫•t b·∫°i: ' + e.message); }
                finally { this.hideLoading(); }
            },

            calculateCurrentWeek() {
                this.STATE.currentWeekSheetName = this.getWeekSheetName();
                const { day } = this.getDateInfo();
                const dayHeaders = ['Ch·ªß Nh·∫≠t', 'Th·ª© 2', 'Th·ª© 3', 'Th·ª© 4', 'Th·ª© 5', 'Th·ª© 6', 'Th·ª© 7'];
                this.STATE.todayColumnHeader = (day >= 1 && day <= 6) ? dayHeaders[day] : dayHeaders[2];
                const dayToIndexMap = {'Th·ª© 2': 3, 'Th·ª© 3': 4, 'Th·ª© 4': 5, 'Th·ª© 5': 6, 'Th·ª© 6': 7};
                this.STATE.todayColumnIndex = dayToIndexMap[this.STATE.todayColumnHeader] || 3;
                document.getElementById('today-column-header').textContent = this.STATE.todayColumnHeader;
                const currentHour = new Date().getHours();
                const defaultShift = currentHour < 15 ? 'S√°ng' : 'Chi·ªÅu';
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.filter-btn[data-shift="${defaultShift}"]`).classList.add('active');
            },

            getWeekSheetName(forNextWeek = false) { const { year, week } = this.getWeekNumber(new Date(), forNextWeek ? 7 : 0); return `${year}-W${String(week).padStart(2, '0')}`; },
            getWeekNumber(d, dayOffset = 0) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7) + dayOffset); const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7); return { year: d.getUTCFullYear(), week: weekNo }; },
            getDateInfo() { const now = new Date(); const day = now.getDay(); const isAfterThursday = day >= 4; return { day, isAfterThursday }; },
            columnIndexToLetter(index) { let letter = '', temp; let col = index + 1; while (col > 0) { temp = (col - 1) % 26; letter = String.fromCharCode(temp + 65) + letter; col = Math.floor((col - 1) / 26); } return letter; }
        };

        InBoldMenuApp.init();
    });
    </script>
</body>
</html>
